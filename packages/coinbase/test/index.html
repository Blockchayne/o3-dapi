<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/o3-dapi-core@0.3.4/lib/o3-dapi-core.min.js"></script>
    <!-- <script type="text/javascript" src="../build/bundle.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/o3-dapi-coinbase@0.0.2/lib/o3-dapi-coinbase.min.js"></script>
    <style media="screen">
      .hidden {
        display: none;
      }

      .col-md-12 {
        margin-bottom: 2rem;
        align-items: center;
      }

      .container {
        text-align: center;
        max-width: 36rem;
        margin: auto;
        padding-top: 2rem;
        flex-direction: column;
      }

      .submit-btn {
        width: 50%;
        margin: auto;
        background: #218FFF;
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        font-size: 1.25rem;
        max-width: 28rem;
        cursor: pointer;
      }

      .screenshot {
        max-width: 28rem;
        width: 100%;
      }

      .hero-img {
        width: 10rem;
      }
    </style>
  </head>
  <body class='container'>

    <div id='auth-splash' class='hidden container row'>

      <div class='col-md-12'>
        <img class='hero-img' src='./assets/coinbaseConnectHero.png' />
      </div>

      <div class='instructions col-md-12'>
        You will soon be prompted to authorize the connection of your Coinbase account for use inside your O3 wallet.
      </div>

      <div class='instructions col-md-12'>
        Please be sure to UPDATE the daily limit that you would like make available for payments via the O3 app.
      </div>

      <div class='col-md-12'>
        <img class='screenshot' src='./assets/screenshotCoinbaseAuth.png' />
      </div>

      <div class='instructions col-md-12'>
        This limit will determine the USD equivilant that you will be able to access each day. Please be sure to set this limit high enough to accomodate any purchases that you plan to make.
      </div>

      <div class='col-md-12'>
        <img class='screenshot' src='./assets/screenshotSpendingLimit.png' />
      </div>

      <div class='instructions col-md-12'>
        Please be sure to keep your O3 wallet open to facilitate this connection.
      </div>

      <div class='col-md-12'>
        <div class='submit-btn' onclick='openOauth()'>
          Connect
        </div>
      </div>
    </div>

    <div id='connecting' class='hidden container'>
      <h1>Connecting your Coinbase account to your O3 wallet.</h1>
    </div>

    <div id='success' class='hidden container'>
      <h1>Your Coinbase account has successfully be connected to your O3 wallet!</h1>
      <br/>
      <h1>You may now close this window.</h1>
    </div>

    <div id='error' class='hidden container'>
      <h1>There was an error connecting your account.</h1>
      <h1>Please be sure you O3 wallet is open, and try again.</h1>
      <div class='submit-btn' onclick='handleRetry()'>
        Connect
      </div>
    </div>

    <script type="text/javascript">
      const elements = {
        splashEle: document.getElementById('auth-splash'),
        connectingEle: document.getElementById('connecting'),
        successEle: document.getElementById('success'),
        errorEle: document.getElementById('error'),
      };

      o3dapi.initPlugins([o3dapiCoinbase]);

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('code');
      const coinbaseurl = urlParams.get('coinbaseurl');

      if (token) {
        handleConnect();
      } else {
        showOnly('splashEle');
      }

      function handleRetry() {
        if (token) {
          handleConnect();
        } else if (coinbaseurl) {
          openOauth();
        }
      }

      function handleConnect() {
        showOnly('connectingEle');
        o3dapi.onReady(provider => {
          o3dapi.COINBASE.connect({token})
          .then(() => {
            showOnly('successEle');
            window.close();
          })
          .catch(err => {
            showOnly('errorEle');
          })
        });
      }

      function openOauth() {
        window.location = decodeURIComponent(coinbaseurl);
      }

      function showOnly(eleKey) {
        Object.keys(elements).forEach(key => {
          const ele = elements[key];
          if (!ele) {
            return;
          }
          ele.style = `display: ${key === eleKey ? 'flex' : 'none'}`;
        });
      }
    </script>
  </body>
</html>
